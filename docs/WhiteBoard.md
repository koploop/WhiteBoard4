# WhiteBoard 设计文档

## 系统架构 (模块化架构)

本项目采用模块化架构，将核心逻辑、元素定义、SDK 接口及 UI 实现进行解耦，以支持 SDK 导出及更好的可维护性。

### 1. boardelement 模块 (底层元素定义)
- **BaseElement**: 所有画板元素的基类，包含位置、缩放、旋转、颜色、层级等基础属性。支持 `erase` 操作。
- **StrokeElement**: 笔迹元素，记录点序列 (Points)、粗细、画笔类型（钢笔、铅笔、马克笔）。支持拆分擦除。
- **TextElement**: 文本元素，包含文本内容、字体大小、颜色等。
- **ImageElement**: 图片元素，包含图片的 Bitmap 引用或路径。
- **BackgroundState**: 背景状态，定义背景类型（网格、纯色、图片）及变换（缩放、偏移）。
- **WhiteBoardState**: 整个画板的状态聚合，包含所有元素列表、当前选中元素、背景配置、交互模式等。

### 2. boardinterface 模块 (SDK 接口层)
- **IWhiteBoardSDK**: 定义了白板 SDK 对外提供的所有功能接口，包括：
    - 交互模式切换（绘制、选择、导航、擦除）。
    - 元素添加（文本、图片）。
    - 画板操作（撤销、重做、清空、删除、复制粘贴、层级调整）。
    - 背景设置。
    - 状态监听（通过 StateFlow 暴露 WhiteBoardState）。

### 3. boardimpl 模块 (SDK 核心实现)
- **WhiteBoardSDKImpl**: `IWhiteBoardSDK` 的核心实现类，同时继承自 `ViewModel` 以支持生命周期管理。
    - 维护撤销/重做栈。
    - 管理 `WhiteBoardState` 的更新逻辑。
- **WhiteBoardSurfaceView**: 自定义 SurfaceView，负责硬件加速渲染逻辑。
    - 采用独立的渲染线程，确保高频率绘图时的流畅度。
    - 响应 SDK 状态变化进行重绘。
- **TouchHandler**: 触摸事件处理器，将原生触摸事件转换为 SDK 的业务操作。

### 4. boardpersist 模块 (持久化层)
- 负责白板数据的保存与加载（预留模块）。

### 5. boardstate 模块 (状态机管理)
- **CanvasStateMachine**: 并行状态机核心，管理不同区域（工具、导航、多指）的状态。
- **ICanvasState**: 状态接口，定义了触摸处理、进入/退出、绘制等逻辑。
- **PenState/SelectionState/EraserState/ZoomPanState**: 具体的功能状态实现。

### 6. accelerate 模块 (硬件加速辅助)
- **AccelerateCanvas**: 加速图层组件，利用硬件厂商提供的显示缓冲区实现超低延迟的划线反馈。

### 6. app 模块 (宿主应用/Demo)
- **MainActivity**: 承载画板视图及工具栏、设置栏，作为 SDK 的集成示例。
- **UI 组件**: 触发 SDK 的各种功能接口。

## 关键技术点

- **坐标系转换**: 区分屏幕坐标系和画板坐标系，支持画布的无限缩放和拖动。
- **高性能渲染**: 针对笔迹和大量元素，使用硬件加速及必要的重绘优化。
- **低延迟划线 (Accelerate Layer)**: 通过直接操作显示缓冲区地址，在手指滑动时实时绘制笔迹，绕过 View 刷新周期，实现极低延迟。
- **交互冲突处理**: 处理多指模式与画布缩放/拖动的互斥逻辑。
- **Lasso/Region Selection**: 在选择模式下，通过滑动创建圈选框。选中多个元素后显示统一的大选中框，并支持群组同步移动。

## 设计变更记录

### V0.1.2 - 性能架构优化
- **空间索引 (QuadTree)**:
    - 引入四叉树算法对画板元素进行空间分割管理。
    - **优化擦除**: 橡皮擦操作通过 QuadTree 快速筛选候选元素，将计算复杂度从 $O(N)$ 降低到 $O(log N)$。
    - **视口剔除**: 渲染时通过 QuadTree 仅查询当前可见区域内的元素。
- **路径简化 (RDP)**:
    - 集成 Ramer-Douglas-Peucker 算法。
    - 笔迹在完成绘制后自动简化冗余点，减少内存占用并提升绘制速度。支持通过 `isSimplificationEnabled` 开关配置。
- **渲染架构升级**:
    - **静态层缓存**: 使用 Android `Picture` 录制机制缓存所有非选中元素。缩放和平移时直接回放 Picture，无需重绘数万个路径。
    - **预排序机制**: 在 `WhiteBoardState` 中维护 `sortedElements`，消除渲染循环中的排序开销。
    - **版本控制**: 引入 `structuralVersion`，仅在结构性变化（增删、选中态改变）时重建缓存，常规变换（移动、缩放）不触发重建。

### V0.1.1 - 元素复制功能优化
- **直接复制并粘贴**:
    - 选中框菜单中的“复制”功能升级。点击后不再仅仅是存入剪贴板，而是直接在当前画板创建副本并粘贴。
    - **偏移策略**：副本自动向右下方偏移 `50px`，方便用户识别新生成的元素。
    - **自动选中**：操作完成后，选中框自动从原元素切换到新生成的副本上，支持连续复制操作。
- **元素克隆机制**:
    - 在 `BaseElement` 基类中引入 `copy()` 抽象接口。
    - 在各具体元素类（如 `StrokeElement`）中实现深度克隆，确保位置、样式、能力等属性完整保留。

### V0.1.0 - 圈选与无限画布优化 (RequestDoc V0.0.6 & V0.0.7)
- **圈选模式 (Lasso Selection)**: 
    - 将原有的框选逻辑升级为圈选。
    - 用户在选择模式下可以自由绘制闭合路径，路径内部及相交的元素将被选中。
- **画布交互升级**: 
    - 工具栏新增画布缩放/平移切换按钮 (`btnZoom`)，替换原有的 `btnCircle`。
    - **缩放/平移逻辑**：缩放/平移不再是一个单独的模式，而是与其他模式（绘制、擦除、圈选）共存。
    - **交互优化**：
        - **互斥执行**：单次多指交互中，系统会根据手指动作自动锁定为“缩放”或“移动”其中一种状态。若手指间距变化超过阈值，锁定为缩放；若中心点偏移超过阈值，锁定为移动。两者在同一次手势中不再同时进行。
        - **防误触触发**：增加“几乎同时落下”的判断（100ms以内）。若一个手指已开始书写较长时间，第二个手指落下将不会触发画布变换，避免书写过程中误触。
        - **起始阈值**：只有当手指间距或位置变化达到一定像素幅度后，才会正式启动缩放或移动操作。
    - **模式冲突处理**：
        - 开启缩放模式后，禁用多指同时书写。此时若双指操作且满足触发条件，则触发画布移动或缩放；若不满足触发条件或为单指操作，则执行当前选中的模式功能。
        - 关闭缩放模式后，启用多指同时书写。此时书写模式下支持多指划线，其他模式（擦除、圈选）仅处理第一根手指的事件。
    - 移除了设置面板中的多指书写独立开关，改为由工具栏按钮统一控制。
- **无限画布支持**: 
    - 优化了坐标变换逻辑，支持用户在任何位置进行移动和缩放，不再受画布边界限制。

### V0.0.9 - 更多工具面板 Item 布局精修
- **Item 视觉调整**: 
    - 图标大小统一调整为 `24dp`，确保居中对齐。
    - 文字大小调整为 `8sp`，支持最多两行显示，并与图标水平居中对齐。
    - 优化了内边距，使紧凑布局下的视觉效果更符合设计要求。

### V0.0.8 - 更多工具面板尺寸优化
- **面板尺寸调整**: 
    - 将 `MoreToolsPanelView` 宽度固定为 `401dp`。
    - 每个工具项 (`ToolItem`) 高度固定为 `36dp`。
    - 面板高度实现了自适应计算，根据内容最多的那一列自动调整高度。
- **UI 细节优化**: 
    - 调整了字体大小和图标尺寸，使整体布局更加精致。

### V0.0.7 - 更多工具面板
- **独立功能面板**: 
    - 实现了 `MoreToolsPanelView` 自定义 View，作为独立的功能入口面板。
    - 面板包含多列工具列表，每一列均支持独立滚动。
- **动态配置支持**: 
    - 引入 `ToolData.kt` 统一管理工具项数据，支持通过简单的配置动态增删功能项。
- **交互逻辑**: 
    - 点击菜单栏 "更多" 按钮弹出面板，点击面板外部空白区域自动关闭。

### V0.0.6 - UI 组件化重构
- **组件提取**: 
    - 将 `activity_main.xml` 中的菜单栏 (Toolbar) 和设置面板 (SettingsPanel) 提取为独立的自定义 View (`ToolbarView` 和 `SettingsPanelView`)。
    - 实现了 UI 逻辑的进一步解耦，使得主布局文件更加简洁，且组件可复用。
- **逻辑优化**: 
    - 明确了按钮点击职责：`btnMenu` 负责触发全局设置面板，`btnSettings` 预留为画笔/工具详细设置触发器。

### V0.0.5 - UI 界面升级 (根据设计稿)
- **菜单栏重构**: 
    - 将底部菜单栏重构为三个独立的悬浮面板（左侧功能区、中间工具区、右侧导航区）。
    - 使用自定义 SVG 矢量图替换原有的文本按钮，提升视觉美观度。
    - 引入深色系设计 (#2C2C2E)，配合 24dp 圆角和阴影效果。
- **资源自包含**: 
    - 为所有菜单项创建了内置的 Vector Drawable 资源，不再依赖外部 SVG 文件。

### V0.0.4 - 模块化重构与 SDK 支持
- **模块化重构**: 
    - 将项目拆分为 `boardelement`, `boardinterface`, `boardimpl`, `boardpersist` 等多个模块。
    - 实现 UI 与业务逻辑的彻底解耦。
- **SDK 接口设计**: 
    - 定义 `IWhiteBoardSDK` 接口，规范白板功能的调用方式。
- **依赖管理优化**: 
    - 统一各模块的 `build.gradle` 配置，优化模块间的依赖关系。
- **应用集成示例**: 
    - 更新 `app` 模块，通过 SDK 接口集成白板功能。

### V0.0.3 - 交互体验与性能优化
- **硬件加速**: 引入 `WhiteBoardSurfaceView` 替代传统 `View`，利用独立渲染线程提升绘图性能。
- **元素擦除**: 
    - 新增橡皮擦模式。
    - 实现基于点序列的笔迹拆分擦除算法，支持将一个笔迹拆分为多个独立的笔迹段。
- **UI 重构**: 区分底部主菜单栏和二级设置面板，优化交互层级。
- **实时绘图**: 实现 `ACTION_MOVE` 过程中的即时笔迹渲染。
- **低延迟集成**: 集成 `accelerate` 模块，实现基于硬件加速图层的低延迟划线反馈及 300ms 智能清除机制。
- **圈选与群组移动**: 
    - 实现滑动区域选中多个元素。
    - 实现多选状态下统一的大选中框展示。
    - 实现选中元素群组的同步移动及撤销优化。


### V0.0.2 - 元素操作增强
- 引入文本和图片元素支持。
- 实现元素的选择、移动、缩放、旋转逻辑。
- 实现层级调整（置顶、置底）及复制粘贴。

### V0.0.1 - 基础框架与绘图
- 初始化项目架构。
- 实现基础背景渲染（网格、纯色、图片）。
- 实现基础笔迹绘制（钢笔、铅笔、马克笔）。
- 实现撤销/重做功能。